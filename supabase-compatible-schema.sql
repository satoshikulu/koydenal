-- =====================================================
-- K√ñYDENAL - SUPABASE UYUMLU VERƒ∞TABANI ≈ûEMASI
-- =====================================================
-- Bu ≈üema Supabase Auth sistemi ile tam uyumludur

-- =====================================================
-- ADIM 1: MEVCUT TABLOLARI Sƒ∞L (Dƒ∞KKAT!)
-- =====================================================

-- NOT: √ñnce mevcut veriyi yedekleyin!
DROP TABLE IF EXISTS admin_actions CASCADE;
DROP TABLE IF EXISTS listings CASCADE;
DROP TABLE IF EXISTS user_profiles CASCADE;
DROP TABLE IF EXISTS categories CASCADE;

-- =====================================================
-- ADIM 2: DOƒûRU ≈ûEMAYI OLU≈ûTUR (SUPABASE AUTH ƒ∞LE UYUMLU)
-- =====================================================

-- Categories tablosu
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL UNIQUE,
    description TEXT,
    icon TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- User profiles tablosu (SUPABASE AUTH ƒ∞LE BAƒûLANTILI)
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT NOT NULL,
    full_name TEXT NOT NULL,
    phone TEXT, -- √úye olmadan da √ßalƒ±≈üsƒ±n diye TEXT
    location TEXT,
    role TEXT DEFAULT 'user',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Listings tablosu (SUPABASE AUTH ƒ∞LE BAƒûLANTILI)
CREATE TABLE listings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    price DECIMAL(10,2) DEFAULT 0,
    currency TEXT DEFAULT 'TRY',
    location TEXT NOT NULL,
    category_id UUID REFERENCES categories(id),
    listing_type TEXT DEFAULT '√ºr√ºn',
    status TEXT DEFAULT 'approved', -- Otomatik onaylƒ± olsun
    quantity DECIMAL(10,2) DEFAULT 1,
    unit TEXT,
    contact_phone TEXT,
    contact_email TEXT,
    contact_person TEXT,
    images TEXT[] DEFAULT '{}',
    main_image TEXT,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE, -- Bo≈ü bƒ±rakƒ±labilir
    approved_by UUID REFERENCES auth.users(id),
    approved_at TIMESTAMP WITH TIME ZONE,
    rejection_reason TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Admin actions tablosu
CREATE TABLE admin_actions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    listing_id UUID REFERENCES listings(id) ON DELETE CASCADE,
    admin_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    action TEXT NOT NULL,
    reason TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- ADIM 3: RLS POLƒ∞Tƒ∞KALARI (SUPABASE AUTH ƒ∞LE UYUMLU)
-- =====================================================

-- Listings tablosu i√ßin RLS - HERKES ƒ∞√áƒ∞N A√áIK
ALTER TABLE listings ENABLE ROW LEVEL SECURITY;

-- Herkes onaylanmƒ±≈ü ilanlarƒ± g√∂rebilir (√ºyelik gerekmez)
CREATE POLICY "Anyone can view listings" ON listings
    FOR SELECT USING (true);

-- √úye olanlar ilan ekleyebilir
CREATE POLICY "Authenticated users can insert listings" ON listings
    FOR INSERT WITH CHECK (auth.uid() IS NOT NULL);

-- Kullanƒ±cƒ±lar kendi ilanlarƒ±nƒ± g√ºncelleyebilir
CREATE POLICY "Users can update own listings" ON listings
    FOR UPDATE USING (auth.uid() = user_id);

-- Herkes ilan ekleyebilir (√ºye olmadan da)
CREATE POLICY "Anyone can insert listings" ON listings
    FOR INSERT WITH CHECK (true);

-- User profiles tablosu i√ßin RLS
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- Kullanƒ±cƒ±lar kendi profillerini g√∂rebilir
CREATE POLICY "Users can view own profile" ON user_profiles
    FOR SELECT USING (auth.uid() = id);

-- Kullanƒ±cƒ±lar kendi profillerini g√ºncelleyebilir
CREATE POLICY "Users can update own profile" ON user_profiles
    FOR UPDATE USING (auth.uid() = id);

-- Herkes profil olu≈üturabilir
CREATE POLICY "Anyone can insert profiles" ON user_profiles
    FOR INSERT WITH CHECK (true);

-- Categories tablosu i√ßin RLS
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;

-- Herkes kategorileri g√∂rebilir
CREATE POLICY "Anyone can view categories" ON categories
    FOR SELECT USING (true);

-- Admin actions i√ßin RLS
ALTER TABLE admin_actions ENABLE ROW LEVEL SECURITY;

-- Sadece adminler admin_actions'ƒ± g√∂rebilir
CREATE POLICY "Admins can view admin actions" ON admin_actions
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM user_profiles
            WHERE id = auth.uid() AND role = 'admin'
        )
    );

-- =====================================================
-- ADIM 4: KATEGORƒ∞LERƒ∞ EKLE
-- =====================================================

INSERT INTO categories (id, name, description, icon, created_at) VALUES
('ceddf343-3ded-4f8a-b5aa-7fde58d34a67', 'Tahƒ±llar', 'Buƒüday, arpa, mƒ±sƒ±r gibi tahƒ±l √ºr√ºnleri', 'üåæ', NOW()),
('51022018-881c-4b1d-a963-bd66bae1f446', 'Sebzeler', 'Domates, biber, patlƒ±can gibi sebzeler', 'ü•ï', NOW()),
('4c8d0f30-aa66-47b1-8e36-139a4e971968', 'Meyveler', 'Elma, armut, ≈üeftali, √ºz√ºm gibi meyveler', 'üçé', NOW()),
('0a943db0-9b30-411b-9ebb-f5ba9882a7bb', 'Bakliyat', 'Mercimek, nohut, fasulye gibi bakliyat √ºr√ºnleri', 'ü´ò', NOW()),
('af2c27dc-707d-48e3-b685-d45249903dd0', 'Hayvancƒ±lƒ±k', 'B√ºy√ºkba≈ü, k√º√ß√ºkba≈ü hayvanlar ve √ºr√ºnleri', 'üêÑ', NOW()),
('c9641343-52e1-46e6-bd76-d5982293dc84', 'Ekipman', 'Trakt√∂r, pulluk, sulama sistemleri', 'üöú', NOW())
ON CONFLICT (id) DO NOTHING;

-- =====================================================
-- ADIM 5: ƒ∞NDEXLER (Performans i√ßin)
-- =====================================================

CREATE INDEX idx_listings_status ON listings(status);
CREATE INDEX idx_listings_category ON listings(category_id);
CREATE INDEX idx_listings_user ON listings(user_id);
CREATE INDEX idx_listings_location ON listings(location);
CREATE INDEX idx_listings_created_at ON listings(created_at);

-- =====================================================
-- ADIM 6: KONTROL VE DOƒûRULAMA
-- =====================================================

-- T√ºm kategorileri listele
SELECT 'Kategoriler y√ºklendi:' as info, COUNT(*) as count FROM categories;

-- T√ºm ilanlarƒ± listele
SELECT 'ƒ∞lanlar:' as info, COUNT(*) as count FROM listings;

-- ƒ∞lan durumlarƒ±nƒ± kontrol et
SELECT
  status,
  COUNT(*) as count
FROM listings
GROUP BY status;

-- Admin kullanƒ±cƒ±larƒ±nƒ± kontrol et
SELECT 'Admin kullanƒ±cƒ±larƒ±:' as info, COUNT(*) as count FROM user_profiles WHERE role = 'admin';

-- ≈ûema kontrol√º
SELECT
  '≈ûema ba≈üarƒ±yla olu≈üturuldu!' as status,
  NOW() as completed_at;
